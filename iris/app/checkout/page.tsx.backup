'use client';

import { useState, useEffect } from 'react';
import { useCart } from '../lib/cart';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { createOrder, createOrGetClient, calculateShippingCost, applyPromoCode } from '../lib/api/client-orders';

export default function CheckoutPage() {
	const { state, totalItems, totalPrice, clear } = useCart();
	const router = useRouter();
	const [isProcessing, setIsProcessing] = useState(false);
	const [currentStep, setCurrentStep] = useState(1);
	const [shippingCost, setShippingCost] = useState(9.99);
	const [promoDiscount, setPromoDiscount] = useState(0);
	const [promoCode, setPromoCode] = useState('');
	const [promoError, setPromoError] = useState('');
	const [isValidatingPromo, setIsValidatingPromo] = useState(false);

	// États du formulaire
	const [formData, setFormData] = useState({
		// Informations personnelles
		firstName: '',
		lastName: '',
		email: '',
		phone: '',
		
		// Adresse de livraison (adresse complète avec ville et CP)
		address: '',
		country: 'France',
		
		// Méthode de paiement
		paymentMethod: 'card',
		cardNumber: '',
		expiryDate: '',
		cvv: '',
		cardName: '',
	});

	// Calculer le total final
	const finalTotal = totalPrice + shippingCost - promoDiscount;

	// Mettre à jour les frais de livraison quand le pays change
	useEffect(() => {
		const cost = calculateShippingCost(formData.country, totalPrice);
		setShippingCost(cost);
	}, [formData.country, totalPrice]);

	const handleInputChange = (field: string, value: string) => {
		setFormData(prev => ({ ...prev, [field]: value }));
	};

	const handlePromoCodeSubmit = async (e: React.FormEvent) => {
		e.preventDefault();
		if (!promoCode.trim()) return;

		setIsValidatingPromo(true);
		setPromoError('');

		try {
			const discount = await applyPromoCode(promoCode, totalPrice);
			setPromoDiscount(discount);
			setPromoError('');
		} catch (error: any) {
			setPromoError(error.message);
			setPromoDiscount(0);
		} finally {
			setIsValidatingPromo(false);
		}
	};

	const handleSubmit = async (e: React.FormEvent) => {
		e.preventDefault();
		setIsProcessing(true);

		try {
			// 1. Créer ou récupérer le client
			const clientId = await createOrGetClient({
				firstName: formData.firstName,
				lastName: formData.lastName,
				email: formData.email,
				phone: formData.phone,
			});

			// 2. Préparer les données de commande
			const orderData = {
				clientId,
				items: state.items.map(item => ({
					productId: item.productId,
					quantity: item.quantity,
					size: item.size,
					price: item.price,
				})),
				shippingAddress: {
					address: formData.address, // Adresse complète avec ville et CP
					country: formData.country,
				},
				promoCode: promoCode || undefined,
				paymentMethod: formData.paymentMethod,
			};

			// 3. Créer la commande
			const { orderId, orderNumber } = await createOrder(orderData);

			// 4. Vider le panier et rediriger
			clear();
			router.push(`/order-confirmation?orderId=${orderId}&orderNumber=${orderNumber}`);
		} catch (error: any) {
			console.error('Error creating order:', error);
			alert('Erreur lors de la création de la commande: ' + error.message);
		} finally {
			setIsProcessing(false);
		}
	};

	const steps = [
		{ id: 1, name: 'Informations', description: 'Vos coordonnées' },
		{ id: 2, name: 'Livraison', description: 'Adresse de livraison' },
		{ id: 3, name: 'Paiement', description: 'Moyen de paiement' },
		{ id: 4, name: 'Confirmation', description: 'Récapitulatif' },
	];

	if (state.items.length === 0) {
		return (
			<main className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
				<div className="max-w-7xl mx-auto px-4 py-12">
					<div className="text-center">
						<h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
							Votre panier est vide
						</h1>
						<p className="text-gray-600 dark:text-gray-400 mb-8">
							Ajoutez des articles à votre panier pour passer commande
						</p>
						<button
							onClick={() => router.push('/products')}
							className="bg-black text-white dark:bg-white dark:text-black px-6 py-3 rounded-xl font-semibold hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors"
						>
							Voir les produits
						</button>
					</div>
				</div>
			</main>
		);
	}

	return (
		<main className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
			<div className="max-w-7xl mx-auto px-4 py-12">
				{/* Header */}
				<div className="mb-8">
					<h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
						Finaliser la commande
					</h1>
					<p className="text-lg text-gray-600 dark:text-gray-300">
						Complétez votre commande en quelques étapes
					</p>
				</div>

				{/* Étapes de commande */}
				<div className="mb-8">
					<nav className="flex items-center justify-center">
						<ol className="flex items-center space-x-8">
							{steps.map((step, stepIdx) => (
								<li key={step.id} className="flex items-center">
									<div className="flex items-center">
										<div className={`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${
											currentStep >= step.id
												? 'bg-blue-600 text-white'
												: 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'
										}`}>
											{step.id}
										</div>
										<div className="ml-4">
											<p className={`text-sm font-medium ${
												currentStep >= step.id
													? 'text-blue-600 dark:text-blue-400'
													: 'text-gray-500 dark:text-gray-400'
											}`}>
												{step.name}
											</p>
											<p className="text-xs text-gray-500 dark:text-gray-400">
												{step.description}
											</p>
										</div>
									</div>
									{stepIdx < steps.length - 1 && (
										<div className="ml-8 w-16 h-0.5 bg-gray-200 dark:bg-gray-700" />
									)}
								</li>
							))}
						</ol>
					</nav>
				</div>

				<div className="grid grid-cols-1 lg:grid-cols-[1fr_400px] gap-8">
					{/* Formulaire de commande */}
					<form onSubmit={handleSubmit} className="space-y-8">
						{/* Étape 1: Informations personnelles */}
						{currentStep === 1 && (
							<div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
								<h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6">
									Informations personnelles
								</h2>
								<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Prénom *
										</label>
										<input
											type="text"
											required
											value={formData.firstName}
											onChange={(e) => handleInputChange('firstName', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Nom *
										</label>
										<input
											type="text"
											required
											value={formData.lastName}
											onChange={(e) => handleInputChange('lastName', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Email *
										</label>
										<input
											type="email"
											required
											value={formData.email}
											onChange={(e) => handleInputChange('email', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Téléphone
										</label>
										<input
											type="tel"
											value={formData.phone}
											onChange={(e) => handleInputChange('phone', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
								</div>
							</div>
						)}

						{/* Étape 2: Adresse de livraison */}
						{currentStep === 2 && (
							<div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
								<h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6">
									Adresse de livraison
								</h2>
								<div className="space-y-4">
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Adresse complète *
										</label>
										<textarea
											required
											value={formData.address}
											onChange={(e) => handleInputChange('address', e.target.value)}
											placeholder="Rue, numéro, ville, code postal"
											rows={3}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Pays *
										</label>
										<select
											value={formData.country}
											onChange={(e) => handleInputChange('country', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										>
											<option value="France">France</option>
											<option value="Belgique">Belgique</option>
											<option value="Suisse">Suisse</option>
											<option value="Autre">Autre</option>
										</select>
									</div>
									{/* Affichage des frais de livraison */}
									<div className="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
										<p className="text-sm text-blue-800 dark:text-blue-200">
											<strong>Frais de livraison :</strong> {shippingCost.toFixed(2)} €
											{formData.country === 'France' && totalPrice >= 75 && (
												<span className="text-green-600 dark:text-green-400 ml-2">(Gratuite dès 75€)</span>
											)}
										</p>
									</div>
								</div>
							</div>
						)}

						{/* Étape 3: Paiement */}
						{currentStep === 3 && (
							<div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
								<h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6">
									Moyen de paiement
								</h2>
								<div className="space-y-4">
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Nom sur la carte *
										</label>
										<input
											type="text"
											required
											value={formData.cardName}
											onChange={(e) => handleInputChange('cardName', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
											Numéro de carte *
										</label>
										<input
											type="text"
											required
											placeholder="1234 5678 9012 3456"
											value={formData.cardNumber}
											onChange={(e) => handleInputChange('cardNumber', e.target.value)}
											className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div>
											<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
												Date d'expiration *
											</label>
											<input
												type="text"
												required
												placeholder="MM/AA"
												value={formData.expiryDate}
												onChange={(e) => handleInputChange('expiryDate', e.target.value)}
												className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
											/>
										</div>
										<div>
											<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
												CVV *
											</label>
											<input
												type="text"
												required
												placeholder="123"
												value={formData.cvv}
												onChange={(e) => handleInputChange('cvv', e.target.value)}
												className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
											/>
										</div>
									</div>
								</div>
							</div>
						)}

						{/* Étape 4: Confirmation */}
						{currentStep === 4 && (
							<div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
								<h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6">
									Récapitulatif de votre commande
								</h2>
								<div className="space-y-4">
									<div>
										<h3 className="font-medium text-gray-900 dark:text-white mb-2">Informations personnelles</h3>
										<p className="text-sm text-gray-600 dark:text-gray-400">
											{formData.firstName} {formData.lastName}
										</p>
										<p className="text-sm text-gray-600 dark:text-gray-400">{formData.email}</p>
									</div>
									<div>
										<h3 className="font-medium text-gray-900 dark:text-white mb-2">Adresse de livraison</h3>
										<p className="text-sm text-gray-600 dark:text-gray-400">
											{formData.address}, {formData.country}
										</p>
									</div>
									<div>
										<h3 className="font-medium text-gray-900 dark:text-white mb-2">Paiement</h3>
										<p className="text-sm text-gray-600 dark:text-gray-400">
											Carte se terminant par {formData.cardNumber.slice(-4)}
										</p>
									</div>
								</div>
							</div>
						)}

						{/* Boutons de navigation */}
						<div className="flex justify-between">
							{currentStep > 1 && (
								<button
									type="button"
									onClick={() => setCurrentStep(currentStep - 1)}
									className="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
								>
									Précédent
								</button>
							)}
							
							{currentStep < 4 ? (
								<button
									type="button"
									onClick={() => setCurrentStep(currentStep + 1)}
									className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
								>
									Suivant
								</button>
							) : (
								<button
									type="submit"
									disabled={isProcessing}
									className="px-8 py-3 bg-black text-white dark:bg-white dark:text-black rounded-lg hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
								>
									{isProcessing ? 'Traitement...' : 'Confirmer la commande'}
								</button>
							)}
						</div>
					</form>

					{/* Récapitulatif de la commande */}
					<aside className="lg:sticky lg:top-8 h-max">
						<div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
							<h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6">
								Votre commande
							</h2>

							{/* Code promotionnel */}
							<div className="mb-6">
								<form onSubmit={handlePromoCodeSubmit} className="flex gap-2">
									<input
										type="text"
										value={promoCode}
										onChange={(e) => setPromoCode(e.target.value)}
										placeholder="Code promo"
										className="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
									/>
									<button
										type="submit"
										disabled={isValidatingPromo || !promoCode.trim()}
										className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm"
									>
										{isValidatingPromo ? '...' : 'Appliquer'}
									</button>
								</form>
								{promoError && (
									<p className="text-red-600 dark:text-red-400 text-sm mt-2">{promoError}</p>
								)}
								{promoDiscount > 0 && (
									<p className="text-green-600 dark:text-green-400 text-sm mt-2">
										Réduction appliquée : -{promoDiscount.toFixed(2)} €
									</p>
								)}
								{/* Codes promo de démonstration */}
								<div className="mt-2 text-xs text-gray-500 dark:text-gray-400">
									<p>Codes de démo :</p>
									<p>• WELCOME10 (10% dès 50€)</p>
									<p>• SAVE20 (20€ dès 100€)</p>
									<p>• FREESHIP (Livraison gratuite)</p>
								</div>
							</div>

							{/* Articles */}
							<div className="space-y-4 mb-6">
								{state.items.map((item) => (
									<div key={`${item.productId}-${item.size ?? 'any'}`} className="flex items-center gap-3">
										<div className="relative h-16 w-16 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden flex-shrink-0">
											<Image 
												src={item.image || '/placeholder.png'} 
												alt={item.title} 
												fill 
												className="object-cover" 
											/>
										</div>
										<div className="flex-1 min-w-0">
											<h3 className="font-medium text-gray-900 dark:text-white text-sm line-clamp-2">
												{item.title}
											</h3>
											<p className="text-xs text-gray-500 dark:text-gray-400">
												Taille {item.size} • Qté {item.quantity}
											</p>
										</div>
										<div className="text-sm font-medium text-gray-900 dark:text-white">
											{(item.price * item.quantity).toFixed(2)} €
										</div>
									</div>
								))}
							</div>

							{/* Total */}
							<div className="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-4">
								<div className="flex justify-between text-gray-600 dark:text-gray-400">
									<span>Sous-total</span>
									<span>{totalPrice.toFixed(2)} €</span>
								</div>
								<div className="flex justify-between text-gray-600 dark:text-gray-400">
									<span>Livraison</span>
									<span className={shippingCost === 0 ? 'text-green-600 dark:text-green-400' : ''}>
										{shippingCost === 0 ? 'Gratuite' : `${shippingCost.toFixed(2)} €`}
									</span>
								</div>
								{promoDiscount > 0 && (
									<div className="flex justify-between text-green-600 dark:text-green-400">
										<span>Réduction</span>
										<span>-{promoDiscount.toFixed(2)} €</span>
									</div>
								)}
								<div className="flex justify-between text-lg font-bold text-gray-900 dark:text-white">
									<span>Total</span>
									<span>{finalTotal.toFixed(2)} €</span>
								</div>
							</div>
						</div>
					</aside>
				</div>
			</div>
		</main>
	);
}
